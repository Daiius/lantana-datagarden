# Lantana DataGarden 開発メモ
枝分かれを含んだ様々なデータを記録するための
Next.js Web アプリケーション
(最初はあくまでポートフォリオ用としたい、
突き詰めればきりがなくなってしまう)

# 汎用性とパフォーマンスの両立を目指して
UI側の技術がかなり向上しそうなので、
より複雑なカスタマイズが可能になりそう

ユーザが自分で項目を設定できるようにしてみたい

## データベース構造検討
ユーザが自分で項目を設定できるならば、
どうしても「間に一枚かませる」必要がありそう。
具体的には、ユーザが編集できるのはテーブル構造でなく、
どんなデータを記録したいか記録したエントリ、ということになる。

これはデータ分析においてある程度の複雑性を生むし、
ボトルネックにもなる（テーブルをすんなり出力するより一手以上遅くなる）

```plantuml
@startuml
hide circle
skinparam linetype ortho
entity Projects {
  name: varchar
  id: UUID
}
entity DataSets {
  name: varchar
  projectId: UUID
  dataSetId: UUID
}
entity DataSetColumns {
  name: varchar <<列名>>
  type: varchar <<型名(参考)>>
  dataSetId: UUID
}
Projects ||-o{ DataSets
DataSets ||-o{ DataSetColumns

@enduml
```
早くも詰まった気がする、どうやって色々なデータ型を受け入れる？
JSON型を使う？にしても適切に扱えるものだろうか...

（現状、なんでも入れられるようにするにはJSONにするしかなさそう）

DataSetsにDataSetsを関連付けたり、入れ子にしたり出来たら
表現力がアップするだろうか？

例えば「ドライトマトのレシピ」Projectにおいて、
「オーブン」というDataSetsがあり、
「温度プロファイル」というDataSetColumnsが定義されているとする

「温度プロファイル」DataSetColumnsは単一データでなく、
時間と温度の2項目からなる配列データである

みたいなことを実現したいものだが...

一回「なんでも入るデータ型」について扱いをちゃんと考えた方がよさそう

## 柔軟な科学データ記録する仕組みの検討
DataSetsの組み合わせ方で、いろんなデータを
表現できそうな点を詰めてみる。

### JSON型を積極的に用いる
パフォーマンスより柔軟性という感覚で進めるならば、
{ "項目1": 値, "項目2": [値2-1, 値2-2], } 的なJSONを使った方が良さそう

(というか、JUMPと連携するという要件が無ければ初めからこの手を考えたかも)

#### ユーザが表の列を定義して、行（データ）を追加できる仕組み検討
もう全部JSONにしちゃうか

### 各種のグループ化について
同じテーブルに属するデータは、その時点で一つのグループとみなせる。

時系列グループ: テーブルに前後関係を与え、それでグループ化

リンク

... グループやリンクなどの概念を組み合わせて、
柔軟なデータ構造を実現することが出来るのではないだろうか...

- リンクのみではトポロジ的な接続しか表現できない
  （どの位置に表示されたら都合が良いかまでは指定できない）

- データがどの位置に表示されるのが都合が良いか表現するために、
  カテゴリやグループといった表現方法を使うイメージが良いだろうか？

- 横方向にグループ化するのと、
  縦方向にグループ化するのとありそう

- 今のところ、リンクされた同質なデータを想像してしまっているが
  全く異なる性質のデータをリンクしたり出来るだろうか？

- リンクとカテゴリには何かしらお互いを制限する要素が有っても
  不自然ではない（時系列カテゴリを遡るリンクは貼れない、とか）

- グループは制限、カテゴリは拡張？
  - グループは既存の属性による分割、
  - カテゴリは専用の属性による分割？
    元々カテゴリ用の分割がされていた場合にどうなるのだろう
  - カテゴリは冗長性や曖昧性を許可するのは有りかも？
    どっちが来てもいいよみたいな
    - A -> B -> C という時系列も、 A -> C -> B という時系列も
      試した記録がある場合、B or C というスーパーカテゴリを作れると
      画面表示がちょっと見やすいかも。
    - AI分析やデータマート出力を考えた場合にはどっちがよいのだろうか
      - どっちが先だったかフラグが有れば割と良い？

- データはparentを持ちうる...というのは、親が一つしかいないデータの
  扱いの場合についてであったが、複数の親がいる場合もあるよね...
  - そうしたらグラフデータベースになるのでは

- 例えば一つのウエハからスタートして、チップに切り分けたものがn個ある
  - ここまでは木構造で表せる
  - 全データを記録する際にはいちいちウェハのデータを入力したくないし、
    逆に分析の際には簡単にアクセス出来る様に（JOIN済みの状態に）したい
  - ウエハのデータは"ウエハ"記録に入れる
    ?? これは何？カテゴリ？

  - 時系列とかカテゴリとかいうより、引き継ぐタイプのデータ分け？
  - むしろデータに合わせてカテゴリ分けされるぐらいの方が良い？
    (データを記録したいのであってカテゴリを記録したいのではないので...)

## テンプレート、カテゴリ
- 最初にデータを追加する際に
  - カテゴリ名を決めます
  - 項目名や型を決めます
    - 項目名や型は、テーブル定義の様なモノです。
      これはカテゴリと直接関連付けてしまうと、
      異なるカテゴリで同じ項目を使いたい際に不便そうなので、
      項目名や型は、内部では「テンプレート」として持っておきます
  - データの入力欄が表形式で作成されます
  - データを入力すると表示欄が増え、末尾に入力欄が出来ます

- 項目をグループとして扱ったり、評価データを
  別テーブルにする方が都合が良いか、ちゃんと結合できるか？
- テンプレートを結合することが出来たら良さそう
  工程Aで条件グループ1を定義した際に、工程Bでも
  条件グループ1を使いまわしたい、ということはあるかもしれない
  - テンプレートは項目名と型のリストなので、結合や追加はし易そう

```mermaid
erDiagram
  Projects {
    id uuidv4
    name string
  }
  Categories {
    id uuidv7
    projectId string FK
    name string
  }
  ColumnDefinitions {
    id uuidv7
    projectId uuidv4
    name string
    type string 
  }

  Data {
    id uuidv7
    parentId uuidv7
    categoryId uuidv7
    created_at timestamp
    data json
  }

  Categories |o--o{ ColumnDefinitions : includes
  
```

- 測定データと条件データを上手く分けることは出来るか？
- 測定データは条件データに関連付けられるというイメージ
  - 表としては別に存在しているが、有る条件データの測定データである、
    ということを表現できないだろうか？
  - relatedId を付けて別のデータと紐づける？
  - 現在はTemplateをCategoryに付け足すことによるデータ拡張ができる
    - 測定データも記録したいときには、測定項目を記録したTemplateを
      Categoryに追加する？
    - 以前は、測定データは有るときも無いときもあるし、
      実機との接続に合わせて列の変更を行う際もあるから別にした

    - process_list と evaluation_list を管理し、
      evaluation_list にはどのprocess_idと紐づくのかや、
      測定の種類を記録していて、
      実際の測定データは固定のテーブルになっていた。
      今回はユーザが定義したテーブルを参照できるようにしたい。

  - 表示画面の軸になるCategoryと、
    そうでないカテゴリ（一種の非表示、内部データ）が有ってもよいかも
    - 測定データの蓄積が内部データに存在していて、
      そこから紐づけを行うなど
      - これ、マスタの仕組みと同じでは

- 一旦整理しなおそう...カテゴリで表を定義して、
  それをデータ表示画面の横軸として使用するイメージ
  - これは条件データに相当するもの
  - 選択肢マスタや測定結果データは大本は別の表にする
    - 具体的には別のカテゴリにし、表示画面の軸でないのでメインには
      表示されない感じになる
  - 測定データは一時的に隠したり簡易表示（存在するかどうか等）したい
    ドライトマトの例を実現できるか考えてみるか...
  - 測定データを追加する際に、どのカテゴリを測定データ扱いするか
    選択できるようにするか？
    - 他のデータと区別がつかない同じ形式でも、どう扱うべきか指定すれば
      適切な方式で扱えるかも...
    - カテゴリ自体にデータタイプが選択肢、関連データ、等設定出来たら
      よいだろうか
- Webアプリケーションであるという性質上、どうしても何か
  表示するためにはサーバからデータを送ることになる。
  ネイティブで動作するアプリケーションと比べて描画処理も遅いし、
  徹底的に通信量や描画量を削減しつつ、データを蓄積できる様にしないと
  - これはビジネスとして生かせる性質かもしれない、
    テスト環境をオンライン上に用意するが、大容量通信を行うのは
    きっとユーザにとっても不便なので、オンプレ？構成とサポートで
    利潤を生むことが出来ないだろうか？
  - データ表示、通信料の削減方法...
    - このアプリケーションはほぼデータの入口、入力フォームとして
      用いられることを想定しているし、実際その様に動作するはず

